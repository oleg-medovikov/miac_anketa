<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Найти и Скачать</title>
    <link rel="icon" href="static/img/miac_short.png">
    <link rel="stylesheet" href="static/index.css">
</head>
<body>

    <header id="header" class="header">
        <div class="container header__container">
            <a href="https://spbmiac.ru/" target="_blank" class="logo_top">
                <img class="logo__img" src="static/img/miac.png" alt="Логотип">
            </a>
            <nav class="menu_top">
                <ul class="menu__list">
                </ul>
            </nav>
        </div>
    </header>

    <div class="box">

        <div class="dropdown-container">
            <div class="input-button-wrapper">
            <input type="text" id="searchInput" class="dropdown-input" placeholder="Поиск по организациям..">

            <div id="dropdownOptions" class="dropdown-options"></div>
                <button id="downloadButton" class="download-button" disabled>Скачать</button>
            </div>
        </div>

    </div>


    <script>
      let selectedOrganizationId = null;

      document.addEventListener('DOMContentLoaded', function() {
          fetch('/organizations')
              .then(response => response.json())
              .then(data => {
                  organizations = data;
                  populateDropdown(organizations);
              })
              .catch(error => console.error('Error fetching organizations:', error));
      });

      document.getElementById('searchInput').addEventListener('input', function() {
          const searchValue = this.value.toLowerCase();
          const filteredOrganizations = organizations.filter(org => org[1].toLowerCase().includes(searchValue));
          populateDropdown(filteredOrganizations);
      });

      function populateDropdown(orgList) {
          const dropdownOptions = document.getElementById('dropdownOptions');
          dropdownOptions.innerHTML = '';
          orgList.forEach(org => {
              const option = document.createElement('div');
              option.className = 'dropdown-option';
              option.textContent = org[1];
              option.dataset.value = org[0];
              option.addEventListener('click', function() {
                  document.getElementById('searchInput').value = this.textContent;
                  selectedOrganizationId = this.dataset.value;
                  document.getElementById('downloadButton').disabled = false;
                  dropdownOptions.style.display = 'none';
              });
              dropdownOptions.appendChild(option);
          });
          dropdownOptions.style.display = orgList.length > 0 ? 'block' : 'none';
      }

      document.getElementById('downloadButton').addEventListener('click', function() {
          if (selectedOrganizationId) {
              fetch('/get_excel', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ oid: selectedOrganizationId })
              })
              .then(response => response.blob())
              .then(blob => {
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'organization_report.xlsx';
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                  window.URL.revokeObjectURL(url);
              })
              .catch((error) => {
                  console.error('Error:', error);
              });
          }
      });
    </script>
</body>
</html>
